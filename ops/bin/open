#!/usr/bin/env bash
set -euo pipefail

format="chatgpt"
intent=""
dp="(none)"
out=""
tag=""
agent_name=""
extra_context=()
agent_role=""
agent_file=""

usage() {
  cat <<'USAGE'
Usage: ops/bin/open [--format=chatgpt|gemini] [--intent="..."] [--dp="DP-XXXX / YYYY-MM-DD"] [--out=auto] [--tag=token] [--agent=name] [--include=PATH]
USAGE
}

die() {
  echo "ERROR: $*" >&2
  exit 1
}

resolve_agent_file() {
  local target="$1"
  local match=""
  local match_count=0
  local file name

  for file in docs/library/agents/R-AGENT-*.md; do
    [[ -f "$file" ]] || continue
    name="$(awk '
      BEGIN { in_header=0 }
      /^---[[:space:]]*$/ { if (in_header == 0) { in_header=1; next } else { exit } }
      in_header && /^name:[[:space:]]*/ {
        sub(/^name:[[:space:]]*/, "", $0)
        print $0
        exit
      }
    ' "$file")"
    if [[ "$name" == "$target" ]]; then
      match="$file"
      match_count=$((match_count + 1))
    fi
  done

  if (( match_count == 0 )); then
    die "Agent not found: ${target}"
  fi
  if (( match_count > 1 )); then
    die "Agent name is ambiguous: ${target}"
  fi

  printf '%s' "$match"
}

extract_agent_role() {
  local file="$1"
  local role

  role="$(awk '
    BEGIN { in_header=0; in_body=0 }
    /^---[[:space:]]*$/ {
      if (in_header == 0) { in_header=1; next }
      in_body=1
      next
    }
    in_body { print }
  ' "$file")"

  role="$(printf '%s\n' "$role" | sed '/./,$!d')"
  if [[ -z "$role" ]]; then
    die "Agent role content missing: ${file}"
  fi

  printf '%s' "$role"
}

for arg in "$@"; do
  case "$arg" in
    --format=chatgpt|--format=gemini)
      format="${arg#--format=}"
      ;;
    --intent=*)
      intent="${arg#--intent=}"
      ;;
    --dp=*)
      dp="${arg#--dp=}"
      ;;
    --out=auto)
      out="auto"
      ;;
    --tag=*)
      tag="${arg#--tag=}"
      ;;
    --agent=*)
      agent_name="${arg#--agent=}"
      ;;
    --include=*)
      extra_context+=("${arg#--include=}")
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "Unknown arg: $arg"
      ;;
  esac
done

branch="$(git rev-parse --abbrev-ref HEAD)"
head_short="$(git rev-parse --short HEAD)"
branch_safe="${branch//\//-}"

tag_prefix=""
if [[ -n "$tag" ]]; then
  tag_prefix="${tag}-"
fi

status_summary="clean"
porcelain_count=0
porcelain_saved="(none)"
porcelain_output=""
porcelain_preview=""

porcelain_raw="$(git status --porcelain || true)"

if [[ -n "$porcelain_raw" ]]; then
  porcelain_count="$(printf "%s\n" "$porcelain_raw" | wc -l | tr -d '[:space:]')"
  status_summary="dirty"
  porcelain_saved="storage/handoff/OPEN-PORCELAIN-${tag_prefix}${branch_safe}-${head_short}.txt"
  printf "%s\n" "$porcelain_raw" > "$porcelain_saved"

  if (( porcelain_count <= 200 )); then
    porcelain_output="$porcelain_raw"
  else
    porcelain_preview="$(printf "%s\n" "$porcelain_raw" | head -n 50)"
  fi
fi

last_commit="$(git log -1 --oneline)"

open_out_path="storage/handoff/OPEN-${tag_prefix}${branch_safe}-${head_short}.txt"
: > "$open_out_path"

required_files=(
  "TRUTH.md"
  "SoP.md"
  "AGENTS.md"
  "TASK.md"
  "docs/INDEX.md"
  "docs/library/MANUAL.md"
  "docs/library/MAP.md"
  "ops/lib/manifests/CONTEXT.md"
)

if [[ -n "$agent_name" ]]; then
  if [[ -z "$agent_name" ]]; then
    die "--agent requires a value"
  fi
  agent_file="$(resolve_agent_file "$agent_name")"
  agent_role="$(extract_agent_role "$agent_file")"
fi

if (( ${#extra_context[@]} > 0 )); then
  for path in "${extra_context[@]}"; do
    if [[ -z "$path" ]]; then
      die "--include requires a value"
    fi
    required_files+=("$path")
  done
fi

missing=()
for path in "${required_files[@]}"; do
  if [[ ! -f "$path" ]]; then
    missing+=("$path")
  fi
done

if (( ${#missing[@]} > 0 )); then
  echo "ERROR: expected files missing. Run from repo root." >&2
  for path in "${missing[@]}"; do
    echo "  - $path" >&2
  done
  exit 1
fi

if [[ "$format" == "gemini" ]]; then
  mode_line="Mode: reviewer stance. Prioritize risks, regressions, and missing tests."
else
  mode_line="Mode: collaborator stance. Follow repo canon and request missing context."
fi

contractor_block="Contractor (assistant): Executes tasks, flags risks, asks when blocked."
if [[ -n "$agent_role" ]]; then
  contractor_block=$'Contractor (assistant):\n'
  contractor_block+="$agent_role"
fi

extra_context_block=""
if (( ${#extra_context[@]} > 0 )); then
  extra_context_block=$'[ADDITIONAL CONTEXT]\n'
  for path in "${extra_context[@]}"; do
    extra_context_block+="- ${path}\n"
  done
  extra_context_block+=$'\n'
fi

emit() {
  if [[ -n "$open_out_path" ]]; then
    tee -a "$open_out_path"
  else
    cat
  fi
}

{
  cat <<EOF
===== OPEN PROMPT =====

Stela OPEN PROMPT

Adhere to the Behavioral Logic Standards defined in AGENTS.md.
$mode_line

[FRESHNESS GATE]
- Active branch: $branch
- HEAD short hash: $head_short
- DP id/date (if applicable): $dp
- Today's intent: $intent

[ROLE CONTRACT]
Integrator (operator): Owns scope, priorities, and approvals.
$contractor_block
AI stance: Canon-first, explicit about unknowns, no invention.

[DO / DON'T]
Do:
- PR-only changes; no main edits.
- Run required gates before close.
Don't:
- Edit main directly.
- Skip gates.

[CONSTITUTION / FOCUS]
- TRUTH.md

[PRIMARY WORK SURFACE]
- TASK.md (DP template + living work log)
- TASK does NOT auto-load unless it's included in your dump/attachments.
- When drafting a DP: follow TASK headings/order; output only the DP; ask if required fields are missing.

[CANON POINTERS]
- TRUTH.md
- TASK.md
- SoP.md
- AGENTS.md
- docs/INDEX.md
- docs/library/MANUAL.md
- docs/library/MAP.md
- ops/lib/manifests/CONTEXT.md

$extra_context_block
[DUMP]
- If you need full repo context, run: ./ops/bin/dump --scope=platform --format=chatgpt (or gemini).
- For a file output: ./ops/bin/dump --scope=platform --format=chatgpt --out=auto

[GIT STATE]
- Working tree: $status_summary
- Porcelain entries: $porcelain_count
- Porcelain saved: $porcelain_saved
- Last commit: $last_commit
EOF

if [[ "$status_summary" == "dirty" ]]; then
  if (( porcelain_count <= 200 )); then
    cat <<EOF
- Porcelain (git status --porcelain):
$porcelain_output
EOF
  else
    cat <<EOF
- Porcelain preview (truncated to 50 lines):
$porcelain_preview
EOF
  fi
fi

  cat <<EOF

[NEXT OPERATOR MOVES]
- ./ops/bin/dump --scope=platform --format=chatgpt

[OPERATOR CONTEXT]
- If any canon pointers are missing, say so.

===== END OPEN PROMPT =====
EOF
} | emit

# IMPORTANT: do not append this line into the OPEN artifact.
if [[ "$out" == "auto" ]]; then
  printf 'OPEN saved: %s\n' "$open_out_path"
fi
