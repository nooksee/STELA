#!/usr/bin/env bash
set -euo pipefail

format="chatgpt"
intent=""
dp="(none)"

usage() {
  cat <<'USAGE'
Usage: ops/bin/open [--format=chatgpt|gemini] [--intent="..."] [--dp="DP-XXXX / YYYY-MM-DD"]
USAGE
}

die() {
  echo "ERROR: $*" >&2
  exit 1
}

for arg in "$@"; do
  case "$arg" in
    --format=chatgpt|--format=gemini)
      format="${arg#--format=}"
      ;;
    --intent=*)
      intent="${arg#--intent=}"
      ;;
    --dp=*)
      dp="${arg#--dp=}"
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "Unknown argument: $arg"
      ;;
  esac
done

if ! command -v git >/dev/null 2>&1; then
  die "git is required but was not found on PATH."
fi

if ! repo_root="$(git rev-parse --show-toplevel 2>/dev/null)"; then
  die "git repo not found. Run from repo root."
fi

if [[ "$(pwd -P)" != "$repo_root" ]]; then
  die "Run from repo root: $repo_root"
fi

branch="$(git rev-parse --abbrev-ref HEAD)"
head_short="$(git rev-parse --short HEAD)"
status_porcelain="$(git status --porcelain)"
if [[ -z "$status_porcelain" ]]; then
  status_summary="clean"
else
  status_summary="dirty"
fi
last_commit="$(git log -1 --oneline)"

required_files=(
  "PROJECT_TRUTH.md"
  "ops/init/icl/context_pack.json"
  "ops/init/icl/ICL_CONTINUITY_CORE.md"
  "STATE_OF_PLAY.md"
  "PROJECT_MAP.md"
  "CANONICAL_TREE.md"
  "docs/00-INDEX.md"
  "ops/init/icl/CONTEXT_PACK.md"
  "ops/init/icl/AI_CONTEXT_SYNC.md"
)

missing=()
for path in "${required_files[@]}"; do
  if [[ ! -f "$path" ]]; then
    missing+=("$path")
  fi
done

if (( ${#missing[@]} > 0 )); then
  echo "ERROR: expected files missing. Run from repo root." >&2
  for path in "${missing[@]}"; do
    echo "  - $path" >&2
  done
  exit 1
fi

if [[ "$format" == "gemini" ]]; then
  mode_line="Mode: reviewer stance. Prioritize risks, regressions, and missing tests."
else
  mode_line="Mode: collaborator stance. Follow repo canon and request missing context."
fi

cat <<EOF
===== OPEN PROMPT =====
nukeCE OPEN PROMPT (Front Door v2.1)
Repo is truth. If a file/path isn't present, say so.
$mode_line
You are entering a canon-governed system.
Precision beats speed.
If unsure, stop and ask.
MEMENTO: M-ATTN-01 (docs/library/MEMENTOS.md)

[FRESHNESS GATE]
- Active branch: $branch
- HEAD short hash: $head_short
- DP id/date (if applicable): $dp
- Today's intent: $intent

[ROLE CONTRACT]
Integrator (operator): Owns scope, priorities, and approvals.
Contractor (assistant): Executes tasks, flags risks, asks when blocked.
AI stance: Canon-first, explicit about unknowns, no invention.

[DO / DON'T]
Do:
- PR-only changes; no main edits.
- Run required gates before close.
Don't:
- Edit main directly.
- Skip gates.

[CONSTITUTION]
- PROJECT_TRUTH.md

[FOCUS RULE]
- PROJECT_TRUTH.md

[CANON POINTERS]
- ops/init/icl/context_pack.json
- ops/init/icl/ICL_CONTINUITY_CORE.md
- STATE_OF_PLAY.md
- PROJECT_MAP.md
- CANONICAL_TREE.md
- docs/00-INDEX.md
- ops/init/icl/CONTEXT_PACK.md
- ops/init/icl/AI_CONTEXT_SYNC.md

[SNAPSHOT]
- If you need full repo context, run: ./ops/bin/snapshot --scope=icl --format=chatgpt (or gemini/claude).
- For a file output: ./ops/bin/snapshot --scope=icl --format=chatgpt --out=auto

[GIT STATE]
- Working tree: $status_summary
- Last commit: $last_commit
EOF

if [[ "$status_summary" == "dirty" ]]; then
  cat <<EOF
- Porcelain (git status --porcelain):
$status_porcelain
EOF
fi

cat <<EOF
[NEXT OPERATOR MOVES]
- ./ops/bin/snapshot --scope=icl --format=chatgpt

[DB-PR-META]
- After approving work results, tell the assistant you approve and ask for DB-PR-META; assistant must emit it immediately.

[OPERATOR CONTEXT]
- If any canon pointers are missing, say so.
===== END OPEN PROMPT =====
EOF
