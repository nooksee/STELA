#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"
# shellcheck source=/dev/null
source "${REPO_ROOT}/ops/lib/scripts/project.sh"

usage() {
  cat <<'USAGE'
Usage:
  ops/bin/project work <id>
USAGE
}

cmd_work() {
  local project_id=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      *)
        if [[ -z "$project_id" ]]; then
          project_id="$1"
        else
          project_die "Unexpected arg: $1"
        fi
        ;;
    esac
    shift
  done

  project_require_valid_id "$project_id"

  local project_dir="${PROJECT_REPO_ROOT}/projects/${project_id}"
  local stela_rel="projects/${project_id}/STELA.md"
  local stela_abs="${PROJECT_REPO_ROOT}/${stela_rel}"

  if [[ ! -d "$project_dir" ]]; then
    project_die "Project directory missing: projects/${project_id}"
  fi

  if [[ ! -f "$stela_abs" ]]; then
    project_die "Missing ${stela_rel}"
  fi

  local branch_name
  branch_name="$(git -C "${PROJECT_REPO_ROOT}" rev-parse --abbrev-ref HEAD)"
  local head_short
  head_short="$(git -C "${PROJECT_REPO_ROOT}" rev-parse --short HEAD)"
  local branch_safe="${branch_name//\//-}"
  if [[ -z "$branch_safe" ]]; then
    branch_safe="unknown-branch"
  fi

  local handoff_dir="${PROJECT_REPO_ROOT}/storage/handoff"
  local dump_dir="${PROJECT_REPO_ROOT}/storage/dumps"
  mkdir -p "$handoff_dir"
  mkdir -p "$dump_dir"

  local open_tag="project-${project_id}"
  local open_path="${handoff_dir}/OPEN-${open_tag}-${branch_safe}-${head_short}.txt"
  local dump_path="${dump_dir}/dump-platform-${branch_safe}-${head_short}.txt"

  if ! "${PROJECT_REPO_ROOT}/ops/bin/open" --intent="Project work: ${project_id}" --tag="${open_tag}" >/dev/null; then
    project_die "Failed to generate OPEN artifact for project: ${project_id}"
  fi

  if ! "${PROJECT_REPO_ROOT}/ops/bin/dump" --scope=platform --format=chatgpt --out=auto >/dev/null; then
    project_die "Failed to generate platform dump for project: ${project_id}"
  fi

  if [[ ! -f "$open_path" ]]; then
    project_die "OPEN artifact missing: ${open_path}"
  fi

  if [[ ! -f "$dump_path" ]]; then
    project_die "Dump payload missing: ${dump_path}"
  fi

  local artifact_rel="storage/handoff/PROJECT-${project_id}-${branch_safe}-${head_short}.txt"
  local artifact_abs="${PROJECT_REPO_ROOT}/${artifact_rel}"

  {
    cat "$open_path"
    echo
    cat "$dump_path"
    echo
    echo "===== PROJECT STELA ====="
    cat "$stela_abs"
  } > "$artifact_abs"

  echo "$artifact_rel"
}

main() {
  project_require_repo_root

  if [[ $# -lt 1 ]]; then
    usage
    exit 1
  fi

  local cmd="$1"
  shift

  case "$cmd" in
    work)
      cmd_work "$@"
      ;;
    -h|--help)
      usage
      ;;
    *)
      project_die "Unknown command: ${cmd}"
      ;;
  esac
}

main "$@"
