#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: ops/bin/help [term]
USAGE
}

die() {
  echo "Stela System: error: $*" >&2
  exit 1
}

color_init() {
  if [[ -n "${TERM:-}" ]] && command -v tput >/dev/null 2>&1 && tput sgr0 >/dev/null 2>&1; then
    bold="$(tput bold)"
    dim="$(tput dim)"
    red="$(tput setaf 1)"
    green="$(tput setaf 2)"
    yellow="$(tput setaf 3)"
    blue="$(tput setaf 4)"
    cyan="$(tput setaf 6)"
    reset="$(tput sgr0)"
  else
    bold=""
    dim=""
    red=""
    green=""
    yellow=""
    blue=""
    cyan=""
    reset=""
  fi
}

say() {
  printf "Stela System: %s\n" "$*"
}

require_repo_root() {
  if ! command -v git >/dev/null 2>&1; then
    die "git is required but was not found on PATH."
  fi

  if ! repo_root="$(git rev-parse --show-toplevel 2>/dev/null)"; then
    die "git repo not found. Run from repo root."
  fi

  if [[ "$(pwd -P)" != "$repo_root" ]]; then
    die "Run from repo root: $repo_root"
  fi
}

show_menu() {
  say "Processing help request."
  cat <<EOF
${bold}Stela Help${reset}
${dim}Explainable command index and quick start.${reset}

${bold}Commands${reset}
  ${cyan}project${reset}  Manage PoT/TASK, status, and work log.
  ${cyan}open${reset}     Generate an OPEN prompt with freshness gate.
  ${cyan}dump${reset}     Capture platform state (excludes projects/).
  ${cyan}help${reset}     Search docs/: ./ops/bin/help <term>

${bold}Quick Start${reset}
  1) Review canon: ${green}PoT.md${reset} and ${green}TASK.md${reset}
  2) Capture context: ${green}./ops/bin/open --intent="..." --dp="DP-XXXX / YYYY-MM-DD"${reset}
  3) Dump platform: ${green}./ops/bin/dump --scope=platform --format=chatgpt${reset}
  4) Check status: ${green}./ops/bin/project status${reset}

${bold}Search${reset}
  ./ops/bin/help <term>  (grep -r in docs/ with line numbers)
EOF
}

search_docs() {
  local term="$1"
  if [[ -z "$term" ]]; then
    die "Search term required."
  fi
  if [[ ! -d "docs" ]]; then
    die "docs/ directory not found."
  fi

  say "Processing search for \"$term\"."
  matches="$(grep -RIn --binary-files=without-match -- "$term" docs/ || true)"
  if [[ -n "$matches" ]]; then
    say "I have located the following references regarding \"$term\":"
    printf "%s\n" "$matches"
  else
    say "No references found regarding \"$term\" in docs/."
  fi
}

color_init
require_repo_root

if (( $# > 1 )); then
  die "Too many arguments."
fi

case "${1:-}" in
  "" )
    show_menu
    ;;
  -h|--help )
    usage
    ;;
  * )
    search_docs "$1"
    ;;
esac
