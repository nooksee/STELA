#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"
SOP_FILE="${REPO_ROOT}/SoP.md"
TASK_FILE="${REPO_ROOT}/TASK.md"
ARCHIVE_DIR="${REPO_ROOT}/storage/archives/root"
HANDOFF_DIR="${REPO_ROOT}/storage/handoff"
THRESHOLD=30

if [[ ! -f "${SOP_FILE}" ]]; then
  echo "ERROR: SoP.md not found at ${SOP_FILE}" >&2
  exit 1
fi

entry_count="$(grep -cE '^## [0-9]{4}-[0-9]{2}-[0-9]{2} ' "${SOP_FILE}" || true)"

if [[ -z "${entry_count}" ]]; then
  entry_count=0
fi

echo "SoP entries: ${entry_count}"

if (( entry_count > THRESHOLD )); then
  mkdir -p "${ARCHIVE_DIR}"
  tmp_keep="$(mktemp)"

  awk -v threshold="${THRESHOLD}" -v keep_file="${tmp_keep}" -v archive_dir="${ARCHIVE_DIR}" '
    BEGIN { entry=0; archive_file="" }
    /^## [0-9]{4}-[0-9]{2}-[0-9]{2} / {
      entry++
      if (entry > threshold) {
        match($0, /^## ([0-9]{4})-([0-9]{2})-([0-9]{2})/, parts)
        archive_file = archive_dir "/SoP-archive-" parts[1] "-" parts[2] ".md"
      }
    }
    {
      if (entry <= threshold) {
        print $0 >> keep_file
      } else {
        print $0 >> archive_file
      }
    }
  ' "${SOP_FILE}"

  mv "${tmp_keep}" "${SOP_FILE}"
  echo "Archived entries beyond ${THRESHOLD}."
else
  echo "SoP within threshold (${THRESHOLD})."
fi

if [[ -d "${HANDOFF_DIR}" ]]; then
  dp_id="${DP_ID:-}"
  if [[ -z "${dp_id}" && -f "${TASK_FILE}" ]]; then
    dp_id="$(awk '/\*\*Current DP\*\*/ {sub(/.*\*\*Current DP\*\*:[[:space:]]*/, "", $0); print $0; exit}' "${TASK_FILE}" | awk '{print $1}')"
    if [[ "${dp_id}" == *"["* || "${dp_id}" == *"]"* ]]; then
      dp_id=""
    fi
  fi

  deleted=0
  kept=0

  while IFS= read -r -d '' file; do
    base="$(basename "${file}")"
    if [[ -n "${dp_id}" && "${base}" == *"${dp_id}"* ]]; then
      kept=$((kept + 1))
      continue
    fi
    rm -f "${file}"
    deleted=$((deleted + 1))
  done < <(find "${HANDOFF_DIR}" -type f -mtime +7 -print0)

  echo "Handoff cleanup: deleted ${deleted}, kept ${kept}."
fi
